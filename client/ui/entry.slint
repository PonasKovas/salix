import { Palette } from "palette.slint";
import { Button, Text, LineEdit, LoadingAnimation } from "widgets.slint";

export component EntryWindow inherits Window {
    in property <string> build-info: "v0.0";

    title: "Salix";
    width: 400px;
    background: Palette.background1;

    callback login(username: string, password: string);
    callback register(username: string, password: string);

    function toggle_disable(disable: bool) {
        login_username.enabled = !disable;
        login_password.enabled = !disable;
        login_button.enabled = !disable;

        register_username.enabled = !disable;
        register_password.enabled = !disable;
        register_password2.enabled = !disable;
        register_button.enabled = !disable;
    }

    function clear_errors() {
        login_username.error = false;
        login_password.error = false;
        register_username.error = false;
        register_password.error = false;
        register_password2.error = false;
    }

    function login_click() {
        clear_errors();

        if login_username.text == "" {
            login_username.error = true;
            return;
        }
        if login_password.text == "" {
            login_password.error = true;
            return;
        }

        toggle_disable(true);

        loading.running = true;
        loading.opacity = 1;
        loading.x = login_panel.x + (login_panel.width - loading.size) / 2;
        loading.y = login_panel.y + (login_panel.height - loading.size) / 2;

        login(login_username.text, login_password.text);
    }

    function register_click() {
        clear_errors();
        
        if register_username.text == "" {
            register_username.error = true;
            return;
        }
        if register_password.text == "" {
            register_password.error = true;
            return;
        }
        if register_password2.text == "" || register_password.text != register_password2.text {
            register_password2.error = true;
            return;
        }


        toggle_disable(true);

        loading.running = true;
        loading.opacity = 1;
        loading.x = register_panel.x + (register_panel.width - loading.size) / 2;
        loading.y = register_panel.y + (register_panel.height - loading.size) / 2;

        register(register_username.text, register_password.text)
    }

    VerticalLayout {
        padding: 15px;
        alignment: start;
        spacing: 20px;

        Text {
            text: "salix";
            font-size: 50px;
            font-weight: 800;
            color: Palette.accent;
            horizontal-alignment: center;
            vertical-stretch: 0;
        }

        login_panel := Rectangle {
            background: Palette.background2;
            vertical-stretch: 1;

            VerticalLayout {
                padding: 7px;
                padding-left: 20px;
                padding-right: 20px;
                spacing: 10px;

                Text {
                    text: "Login";
                    horizontal-alignment: left;
                }
                login_username := LineEdit {
                    placeholder-text: "username";
                    init => { self.focus() }
                }
                login_password := LineEdit {
                    placeholder-text: "password";
                    input-type: password;
                }
                login_button := Button {
                    text: "login";

                    clicked => {
                        login_click();
                    }
                }
            }
        }

        Text {
            text: "or";
            font-weight: 600;
            horizontal-alignment: center;
        }

        register_panel := Rectangle {
            background: Palette.background2;
            vertical-stretch: 1;

            VerticalLayout {
                padding: 7px;
                padding-left: 20px;
                padding-right: 20px;
                spacing: 10px;

                Text {
                    text: "New account";
                    horizontal-alignment: left;
                }
                register_username := LineEdit {
                    placeholder-text: "username";
                }
                register_password := LineEdit {
                    placeholder-text: "password";
                    input-type: password;
                }
                register_password2 := LineEdit {
                    placeholder-text: "password";
                    input-type: password;
                }
                register_button := Button {
                    text: "create";

                    clicked => {
                        register_click();
                    }
                }
            }
        }

        Text {
            text: root.build-info;
            color: Palette.text2;
            horizontal-alignment: right;
        }
    }

    loading := LoadingAnimation {
        size: 128px;
        running: false;
        opacity: 0;

        animate opacity {
            duration: 1s;
            easing: ease;
        }
    }
}